name: Deploy Storybook
run-name: ${{ github.actor }}ì˜ ìŠ¤í† ë¦¬ë¶ ë°°í¬
on:
  pull_request:
    branches: ['develop']
    paths:
      - apps/storybook/**
      - packages/ui/src/**

jobs:
  chromatic:
    runs-on: ubuntu-latest

    # Dependabot ë´‡ì¸ ê²½ìš° ë°°í¬ ìŠ¤í‚µ
    if: github.event.pull_request.user.login != 'dependabot[bot]'
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        id: pnpm-install
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile # ì˜ì¡´ì„± ë²„ì „ ë¶ˆì¼ì¹˜ í—ˆìš©

      - name: Run Chromatic
        id: chromatic
        uses: chromaui/action@latest
        with:
          workingDir: apps/storybook
          projectToken: ${{ secrets.CHROMATIC_TOKEN }}
          onlyChanged: true # TurboSnap í™œì„±í™”
          externals: packages/(ui/src)/** # ì™¸ë¶€ ì˜ì¡´ì„± ê²½ë¡œ

      - name: Create comment PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: ${{github.event.number}}-storybook
          mode: 'recreate' # ê¸°ì¡´ ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±
          message: |
            <table>
              <tr>
                <th>ğŸ“š Storybook</th>
                <td><a href="${{ steps.chromatic.outputs.storybookUrl }}">${{ steps.chromatic.outputs.storybookUrl }}</a></td>
              </tr>
              <tr>
                <th>ğŸ§ª Inspect</th>
                <td><a href="${{ steps.chromatic.outputs.buildUrl }}">${{ steps.chromatic.outputs.buildUrl }}</a></td>
              </tr>
              <tr>
                <th>ğŸ–¼ï¸ Changed</th>
                <td><strong>${{ steps.chromatic.outputs.changeCount }}</strong> changed</td>
              </tr>
            </table>
