name: Build & Deploy Knockdog

on:
  push:
    branches: [chore/init-docker]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Node.js + pnpm 설치 (정적 파일 빌드를 위해)
      - name: Setup Node.js & PNPM
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.6

      - name: Install dependencies
        run: pnpm install

      - name: Create empty .env.production
        run: |
          mkdir -p apps/knockdog
          echo "NEXT_PUBLIC_ASSET_PREFIX=${{ secrets.CDN_URL }}" > apps/knockdog/.env.production

      - name: Build Knockdog
        run: pnpm dlx turbo run build --filter=knockdog...

      # 빌드 결과물 디렉토리 구조 잘 있는지 확인
      - name: Verify .next/standalone/server.js exists
        run: |
          echo "🔍 Checking for server.js in .next/standalone..."
          if [ -f apps/knockdog/.next/standalone/server.js ]; then
            echo "✅ server.js exists!"
          else
            echo "❌ server.js not found! Failing the build."
            exit 1
          fi
      # 기존 Build Knockdog 직후에 삽입
      - name: Debug .next directory
        run: |
          echo "🔍 apps/knockdog 디렉터리 구조:"
          ls -R apps/knockdog

          echo "🔍 .next 내부 구조:"
          ls -R apps/knockdog/.next || true

          echo "🔍 standalone 유무 확인:"
          if [ -d apps/knockdog/.next/standalone ]; then
            echo "✅ standalone 폴더 존재!"
            ls -R apps/knockdog/.next/standalone
          else
            echo "❌ standalone 폴더가 없습니다!"
            # 실패로 처리하고 싶으면 아래 줄 주석 해제
            # exit 1
        fi


      # AWS 자격증명 설정 (S3 업로드용)
      - name: Configure AWS credentials for S3
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}


      # 정적 파일을 S3로 업로드
      - name: Upload .next/static to S3
        run: |
          aws s3 sync apps/knockdog/.next/static \
            s3://knockdog-v2-assets/knockdog/_next/static \
            --acl private --delete

      - name: Upload public to S3
        run: |
          aws s3 sync apps/knockdog/public \
            s3://knockdog-v2-assets/knockdog/public \
            --acl private --delete

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # AWS 자격증명 설정 (ECR 로그인용)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ECR 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image to ECR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/knockdog/Dockerfile
          target: runner
          push: true
          tags: ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest
          build-args: |
            PROJECT=knockdog
            ENV_FILE=.env.production

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} \
              | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
            docker pull ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest
            docker stop knockdog || true
            docker rm knockdog   || true
            docker run -d --name knockdog -p 3000:3000 \
              --restart unless-stopped \
              -e NODE_ENV=production \
              ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest
